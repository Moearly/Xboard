# 多租户数据隔离指南

## 一、租户隔离的数据（每个租户独立）

### 已完成隔离的模型
✅ **User** - 用户数据
✅ **Order** - 订单数据
✅ **Plan** - 套餐配置
✅ **Payment** - 支付方式配置
✅ **Coupon** - 优惠券
✅ **Notice** - 公告通知
✅ **Knowledge** - 知识库
✅ **Ticket** - 工单系统
✅ **InviteCode** - 邀请码

### 需要隔离的功能模块
1. **用户管理**
   - 每个租户只能看到自己的用户
   - 用户注册自动归属到对应租户
   - 用户统计按租户分开

2. **订单管理**
   - 订单数据完全隔离
   - 收入统计按租户分开
   - 支付回调自动识别租户

3. **套餐管理**
   - 每个租户可以创建自己的套餐
   - 套餐价格独立设置
   - 套餐权限组独立配置

4. **支付配置**
   - 每个租户配置自己的支付接口
   - 支付密钥独立管理
   - 支付记录隔离

5. **营销工具**
   - 优惠券按租户隔离
   - 公告通知独立发布
   - 知识库内容独立管理

6. **工单系统**
   - 工单完全隔离
   - 客服只能看到本租户工单
   - 工单统计按租户分开

## 二、共享资源（所有租户共用）

### 共享的模型（不添加 tenant_id）
- **Server** - 节点服务器
- **ServerGroup** - 服务器组
- **ServerRoute** - 服务器路由
- **Plugin** - 插件系统
- **Setting** - 系统设置（部分）

### 共享的功能
1. **节点管理**
   - 所有租户共享同一套节点
   - 节点的添加/删除由超级管理员管理
   - 租户可以选择使用哪些节点

2. **系统配置**
   - 邮件服务器配置（可选共享或独立）
   - 系统更新
   - 插件管理

## 三、混合模式（部分共享，部分隔离）

### 统计数据
- **全局统计**：超级管理员可以看到所有租户的汇总数据
- **租户统计**：每个租户只能看到自己的数据

### 节点权限
- **节点池**：所有节点由超级管理员管理
- **节点分配**：可以为每个租户分配可用节点
- **节点显示**：租户只能看到分配给自己的节点

## 四、实现细节

### 1. 自动租户识别
```php
// 通过域名自动识别租户
$tenant = Tenant::where('domain', $request->getHost())->first();
```

### 2. 数据自动过滤
```php
// 使用 BelongsToTenant trait 自动过滤
User::all(); // 自动只返回当前租户的用户
```

### 3. 创建数据时自动设置租户
```php
// 创建时自动设置 tenant_id
$user = User::create([...]);  // 自动设置当前租户ID
```

## 五、管理界面适配

### 需要修改的页面/功能

1. **仪表板**
   - ✅ 统计数据按租户过滤
   - ✅ 收入统计按租户分开
   - ✅ 用户增长按租户统计

2. **用户管理**
   - ✅ 用户列表自动过滤
   - ✅ 用户搜索限制在租户内
   - ✅ 用户统计按租户分开

3. **订单管理**
   - ✅ 订单列表自动过滤
   - ✅ 订单统计按租户分开
   - ✅ 收入报表按租户生成

4. **套餐管理**
   - ✅ 套餐列表按租户过滤
   - ✅ 套餐创建自动归属租户
   - ✅ 套餐统计独立计算

5. **节点管理**（特殊处理）
   - ⚠️ 节点列表：显示分配给租户的节点
   - ⚠️ 节点创建：仅超级管理员可操作
   - ⚠️ 节点分配：超级管理员分配给租户

6. **系统设置**
   - ⚠️ 部分设置全局共享
   - ⚠️ 部分设置租户独立
   - ⚠️ 需要区分设置类型

## 六、API 接口适配

所有 API 接口已通过中间件自动适配：
- `/api/v2/admin/*` - 管理接口自动应用租户过滤
- `/api/v2/user/*` - 用户接口自动应用租户过滤
- `/api/v2/admin/tenant/*` - 仅超级管理员可访问

## 七、注意事项

1. **数据迁移**
   - 现有数据需要手动分配租户ID
   - 可以创建默认租户迁移现有数据

2. **性能优化**
   - 所有查询自动添加 tenant_id 索引
   - 考虑为大租户单独优化

3. **安全考虑**
   - 租户数据严格隔离
   - API 请求自动验证租户权限
   - 防止跨租户数据泄露

## 八、测试清单

- [ ] 用户注册/登录 - 自动归属正确租户
- [ ] 订单创建 - 订单归属正确租户
- [ ] 套餐购买 - 只能购买本租户套餐
- [ ] 工单提交 - 工单归属正确租户
- [ ] 统计数据 - 数据隔离正确
- [ ] 支付回调 - 正确识别租户
- [ ] 节点访问 - 只能使用分配的节点